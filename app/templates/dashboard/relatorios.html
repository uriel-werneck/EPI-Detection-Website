{% extends "dashboard/navbar.html" %}

{% block title %}Relatórios - EPI Detection{% endblock %}

{% block styles %}
<style>
    @media print {
        body * {
            visibility: hidden;
        }
        #report-content, #report-content * {
            visibility: visible;
        }
        #report-content {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            margin: 0;
            padding: 10mm;
        }
        .no-print {
            display: none !important;
        }
        
        .chart-container {
            height: 180px !important;
            max-height: 180px !important;
            width: 100% !important;
            margin-bottom: 15px !important;
            page-break-inside: avoid;
        }
        
        #stats-cards-section,
        #bar-chart-section,
        #pie-chart-section,
        #time-series-section {
            page-break-inside: avoid;
            margin-bottom: 20px !important;
        }
        
        h2, h3 {
            margin-top: 10px !important;
            margin-bottom: 10px !important;
            font-size: 16px !important;
        }
        
        .page-break-after {
            page-break-after: always;
        }
        
        .grid {
            display: block !important;
        }
        
        .grid > div {
            margin-bottom: 10px !important;
            width: 100% !important;
        }
    }
    
    .chart-selection-item {
        transition: all 0.2s ease;
    }
    
    .chart-selection-item.disabled {
        opacity: 0.5;
    }
    
    .report-logo {
        max-height: 50px;
        width: auto;
    }
    
    .pdf-mode .chart-container {
        height: 180px !important;
        max-height: 180px !important;
    }
    
    .pdf-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .pdf-loading-text {
        margin-top: 20px;
        font-size: 18px;
        font-weight: bold;
    }
    
    .spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-8 max-w-7xl">
    <!-- Loading indicator for PDF generation -->
    <div id="pdf-loading" class="pdf-loading" style="display: none;">
        <div class="spinner"></div>
        <div class="pdf-loading-text">Gerando PDF, por favor aguarde...</div>
    </div>

    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-3xl font-bold tracking-tight">Relatórios</h1>
            <p class="text-muted-foreground">Visualize e exporte relatórios detalhados sobre detecções de EPIs</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="date-filter-btn" class="inline-flex items-center px-3 py-2 rounded-md text-sm font-medium gap-2 text-gray-600 hover:bg-gray-100 border no-print">
                <i data-lucide="calendar" class="h-4 w-4"></i>
                Filtrar por Data
            </button>
                    <!-- Date Filter Dropdown -->
            <!-- Date Filter Dropdown (ADD THIS AS NEW CODE) -->
            <div id="date-filter-dropdown" class="absolute right-0 mt-2 w-72 bg-white rounded-md shadow-lg z-10 border border-gray-200 p-4 hidden no-print">
                <h4 class="text-sm font-medium mb-3">Filtrar por período</h4>
                
                <div class="space-y-3">
                    <div>
                        <label for="start-date" class="block text-xs font-medium text-gray-700 mb-1">Data inicial</label>
                        <input type="date" id="start-date" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm">
                    </div>
                    
                    <div>
                        <label for="end-date" class="block text-xs font-medium text-gray-700 mb-1">Data final</label>
                        <input type="date" id="end-date" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm">
                    </div>
                    
                    <div class="flex items-center space-x-2 pt-2">
                        <button id="apply-date-filter" class="flex-1 bg-primary text-white rounded-md px-3 py-2 text-sm font-medium">
                            Aplicar
                        </button>
                        <button id="clear-date-filter" class="flex-1 border border-gray-300 rounded-md px-3 py-2 text-sm font-medium">
                            Limpar
                        </button>
                    </div>
                </div>
            </div>
                        <button id="export-pdf-btn" class="inline-flex items-center px-3 py-2 rounded-md text-sm font-medium gap-2 bg-primary text-white hover:bg-primary/90 no-print">
                <i data-lucide="download" class="h-4 w-4"></i>
                Exportar PDF
            </button>
        </div>
    </div>

    <!-- Chart Selection Section -->
    <div class="mt-8 rounded-lg border bg-card text-card-foreground shadow-sm p-6 no-print">
        <h3 class="text-lg font-medium mb-4">Selecione os gráficos para o relatório</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="chart-selection-item flex items-center space-x-2">
                <input type="checkbox" id="stats-cards-toggle" class="chart-toggle h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" checked>
                <label for="stats-cards-toggle" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                    Estatísticas de Upload
                </label>
            </div>
            
            <div class="chart-selection-item flex items-center space-x-2">
                <input type="checkbox" id="bar-chart-toggle" class="chart-toggle h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" checked>
                <label for="bar-chart-toggle" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                    Quantidade de Objetos
                </label>
            </div>
            
            <div class="chart-selection-item flex items-center space-x-2">
                <input type="checkbox" id="pie-chart-toggle" class="chart-toggle h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" checked>
                <label for="pie-chart-toggle" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                    Distribuição dos Objetos
                </label>
            </div>
            
            <div class="chart-selection-item flex items-center space-x-2">
                <input type="checkbox" id="time-series-toggle" class="chart-toggle h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" checked>
                <label for="time-series-toggle" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                    Evolução por Data
                </label>
            </div>
        </div>
    </div>

    <!-- Report Preview Section -->
    <div id="report-content" class="mt-8">
        <!-- Report Header -->
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold">Relatório de Detecção de EPIs</h2>
                <p class="text-sm text-gray-500">Gerado em: <span id="report-date">{{ now.strftime('%d/%m/%Y %H:%M') }}</span></p>
                <p class="text-sm text-gray-500">Usuário: {{ current_user.nome }} {{ current_user.sobrenome }}</p>
            </div>
            <img src="{{ url_for('static', filename='images/logo-projeto.svg') }}" alt="SafetyAI Logo" class="report-logo" />
        </div>

        <!-- Stats Cards Section -->
        <div id="stats-cards-section" class="mb-8">
            <h3 class="text-xl font-semibold mb-4 pb-2 border-b">Estatísticas de Upload</h3>
            <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-2">
                <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-6 bg-purple-100">
                    <div class="flex flex-row items-center justify-between space-y-0 pb-2">
                        <h3 class="text-sm font-medium">Uploads de Imagens</h3>
                        <i data-lucide="image" class="h-4 w-4 text-muted-foreground"></i>
                    </div>
                    <div class="text-2xl font-bold text-purple-700">{{ detection_stats.total_images }}</div>
                </div>

                <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-6 bg-green-100">
                    <div class="flex flex-row items-center justify-between space-y-0 pb-2">
                        <h3 class="text-sm font-medium">Uploads de Vídeos</h3>
                        <i data-lucide="video" class="h-4 w-4 text-muted-foreground"></i>
                    </div>
                    <div class="text-2xl font-bold text-green-700">{{ detection_stats.video_count|default(0) }}</div>
                </div>
            </div>
        </div>

        <!-- Bar Chart Section -->
        <div id="bar-chart-section" class="mb-8">
            <h3 class="text-xl font-semibold mb-4 pb-2 border-b">Quantidade de Objetos Detectados</h3>
            <div class="chart-container" style="height: 250px;">
                <canvas id="classesChart"></canvas>
            </div>
        </div>

        <!-- Pie Chart Section -->
        <div id="pie-chart-section" class="mb-8">
            <h3 class="text-xl font-semibold mb-4 pb-2 border-b">Distribuição dos Objetos</h3>
            <div class="chart-container" style="height: 250px;">
                <canvas id="distributionChart"></canvas>
            </div>
        </div>

        <!-- Time Series Chart Section -->
        <div id="time-series-section" class="mb-8">
            <h3 class="text-xl font-semibold mb-4 pb-2 border-b">Evolução da Detecção de Objetos por Data</h3>
            <div class="chart-container" style="height: 300px;">
                <canvas id="timeSeriesChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
    const detectedClasses = JSON.parse('{{ detection_stats.detected_classes | tojson | safe }}');
    const timeSeriesData = JSON.parse('{{ detection_stats.time_series_data | tojson | safe }}');
    
    const colorPalette = [
        '#4361ee', '#3a0ca3', '#7209b7', '#f72585', '#4cc9f0', 
        '#4895ef', '#560bad', '#f15bb5', '#00bbf9', '#00f5d4'
    ];
    
    let classesChart, distributionChart, timeSeriesChart;
    
    function initCharts() {
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 0 
            },
            plugins: {
                legend: {
                    labels: {
                        boxWidth: 15,
                        font: {
                            size: 11 
                        }
                    }
                }
            }
        };
        
        const classesCtx = document.getElementById('classesChart');
        classesChart = new Chart(classesCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(detectedClasses),
                datasets: [{
                    label: 'Quantidade de Detecções',
                    data: Object.values(detectedClasses),
                    backgroundColor: Object.keys(detectedClasses).map((_, index) => colorPalette[index % colorPalette.length]),
                    borderWidth: 0,
                    borderRadius: 4
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantidade',
                            font: {
                                size: 11
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Objeto',
                            font: {
                                size: 11
                            }
                        },
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 10,
                        cornerRadius: 6,
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw} detecções`;
                            }
                        }
                    }
                }
            }
        });

        const distributionCtx = document.getElementById('distributionChart');
        distributionChart = new Chart(distributionCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(detectedClasses),
                datasets: [{
                    data: Object.values(detectedClasses),
                    backgroundColor: Object.keys(detectedClasses).map((_, index) => colorPalette[index % colorPalette.length]),
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                ...commonOptions,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 15,
                            padding: 10,
                            font: {
                                size: 10
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 10,
                        cornerRadius: 6,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((context.raw / total) * 100);
                                return `${context.label}: ${percentage}%`;
                            }
                        }
                    }
                }
            }
        });

        const timeSeriesCtx = document.getElementById('timeSeriesChart');
        timeSeriesChart = new Chart(timeSeriesCtx, {
            type: 'line',
            data: {
                labels: timeSeriesData.dates,
                datasets: [
                    {
                        label: 'Objetos Detectados',
                        data: timeSeriesData.detections,
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#4361ee',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Uploads de Imagens',
                        data: timeSeriesData.uploads,
                        borderColor: '#f72585',
                        backgroundColor: 'rgba(247, 37, 133, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#f72585',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }
                ]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantidade',
                            font: {
                                size: 11
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Data',
                            font: {
                                size: 11
                            }
                        },
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        align: 'end',
                        labels: {
                            boxWidth: 15,
                            padding: 10,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            font: {
                                size: 10
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 10,
                        cornerRadius: 6,
                        mode: 'index',
                        intersect: false
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }
    
    function updateChartVisibility() {
        const statsCardsVisible = document.getElementById('stats-cards-toggle').checked;
        const barChartVisible = document.getElementById('bar-chart-toggle').checked;
        const pieChartVisible = document.getElementById('pie-chart-toggle').checked;
        const timeSeriesVisible = document.getElementById('time-series-toggle').checked;
        
        document.getElementById('stats-cards-section').style.display = statsCardsVisible ? 'block' : 'none';
        document.getElementById('bar-chart-section').style.display = barChartVisible ? 'block' : 'none';
        document.getElementById('pie-chart-section').style.display = pieChartVisible ? 'block' : 'none';
        document.getElementById('time-series-section').style.display = timeSeriesVisible ? 'block' : 'none';
    }
    
    function prepareChartsForPDF() {
        document.body.classList.add('pdf-mode');
        
        if (classesChart) {
            classesChart.options.plugins.legend.display = false;
            classesChart.resize();
        }
        
        if (distributionChart) {
            distributionChart.options.plugins.legend.position = 'right';
            distributionChart.options.plugins.legend.labels.boxWidth = 10;
            distributionChart.options.plugins.legend.labels.font.size = 8;
            distributionChart.resize();
        }
        
        if (timeSeriesChart) {
            timeSeriesChart.options.plugins.legend.position = 'top';
            timeSeriesChart.options.plugins.legend.labels.font.size = 8;
            timeSeriesChart.resize();
        }
        
        window.dispatchEvent(new Event('resize'));
    }
    
    function restoreChartsAfterPDF() {
        document.body.classList.remove('pdf-mode');
        
        if (classesChart) classesChart.resize();
        if (distributionChart) distributionChart.resize();
        if (timeSeriesChart) timeSeriesChart.resize();
        
        window.dispatchEvent(new Event('resize'));
    }
    
    async function generatePDF() {
        try {
            document.getElementById('pdf-loading').style.display = 'flex';
            
            document.getElementById('report-date').textContent = new Date().toLocaleString('pt-BR');
            
            prepareChartsForPDF();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const originalContent = document.getElementById('report-content');
            const clonedContent = originalContent.cloneNode(true);
            
            const canvases = originalContent.querySelectorAll('canvas');
            const clonedCanvases = clonedContent.querySelectorAll('canvas');
            
            for (let i = 0; i < canvases.length; i++) {
                const canvas = canvases[i];
                const clonedCanvas = clonedCanvases[i];
                
                const img = new Image();
                img.src = canvas.toDataURL('image/png');
                
                const parent = clonedCanvas.parentNode;
                parent.replaceChild(img, clonedCanvas);
            }
            
            const tempContainer = document.createElement('div');
            tempContainer.appendChild(clonedContent);
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            document.body.appendChild(tempContainer);
            
            const options = {
                margin: [10, 10, 10, 10],
                filename: 'relatorio-epi-detection.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    letterRendering: true,
                    allowTaint: true,
                    imageTimeout: 0, 
                    width: 794 
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait',
                    compress: true
                }
            };
            
            await html2pdf().set(options).from(clonedContent).save();
            
            document.body.removeChild(tempContainer);
            restoreChartsAfterPDF();
            
            document.getElementById('pdf-loading').style.display = 'none';
        } catch (error) {
            console.error('PDF generation error:', error);
            alert('Ocorreu um erro ao gerar o PDF. Por favor, tente novamente.');
            
            document.getElementById('pdf-loading').style.display = 'none';
            restoreChartsAfterPDF();
        }
    }
    
    async function generatePDFAlternative() {
        try {
            document.getElementById('pdf-loading').style.display = 'flex';
            
            document.getElementById('report-date').textContent = new Date().toLocaleString('pt-BR');
            
            prepareChartsForPDF();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const element = document.getElementById('report-content');
            
            const options = {
                margin: [10, 10, 10, 10],
                filename: 'relatorio-epi-detection.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: true, 
                    letterRendering: true,
                    allowTaint: true,
                    imageTimeout: 0, 
                    width: 794, 
                    height: undefined, 
                    windowWidth: 1200, 
                    windowHeight: 1600 
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait',
                    compress: true
                }
            };
            
            await html2pdf().set(options).from(element).save();
            
            restoreChartsAfterPDF();
            
            document.getElementById('pdf-loading').style.display = 'none';
        } catch (error) {
            console.error('PDF generation error:', error);
            alert('Ocorreu um erro ao gerar o PDF. Por favor, tente novamente.');
            
            document.getElementById('pdf-loading').style.display = 'none';
            restoreChartsAfterPDF();
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('report-date').textContent = new Date().toLocaleString('pt-BR');
        
        initCharts();
        
        document.querySelectorAll('.chart-toggle').forEach(toggle => {
            toggle.addEventListener('change', updateChartVisibility);
        });
        
        document.getElementById('export-pdf-btn').addEventListener('click', generatePDF);
        
        updateChartVisibility();
        
        window.addEventListener('resize', function() {
            if (classesChart) classesChart.resize();
            if (distributionChart) distributionChart.resize();
            if (timeSeriesChart) timeSeriesChart.resize();
        });
    });

    // Date filter functionality (ADD THIS AS NEW CODE)
    document.addEventListener('DOMContentLoaded', function() {
        // Get references to date filter elements
        const dateFilterBtn = document.getElementById('date-filter-btn');
        const dateFilterDropdown = document.getElementById('date-filter-dropdown');
        const applyDateFilterBtn = document.getElementById('apply-date-filter');
        const clearDateFilterBtn = document.getElementById('clear-date-filter');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        
        // Set default date values (last 7 days)
        const today = new Date();
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(today.getDate() - 7);
        
        startDateInput.valueAsDate = sevenDaysAgo;
        endDateInput.valueAsDate = today;
        
        // Toggle date filter dropdown
        dateFilterBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            dateFilterDropdown.classList.toggle('hidden');
            
            // Position the dropdown relative to the button
            const buttonRect = dateFilterBtn.getBoundingClientRect();
            dateFilterDropdown.style.top = `${buttonRect.bottom + window.scrollY}px`;
            dateFilterDropdown.style.right = `${window.innerWidth - buttonRect.right}px`;
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dateFilterDropdown.contains(e.target) && e.target !== dateFilterBtn) {
                dateFilterDropdown.classList.add('hidden');
            }
        });
        
        // Apply date filter
        applyDateFilterBtn.addEventListener('click', function() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (startDate && endDate) {
                // Redirect to the same page with date filter parameters
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('start_date', startDate);
                currentUrl.searchParams.set('end_date', endDate);
                window.location.href = currentUrl.toString();
            } else {
                alert('Por favor, selecione as datas inicial e final.');
            }
        });
        
        // Clear date filter
        clearDateFilterBtn.addEventListener('click', function() {
            // Reset the input fields to default values
            startDateInput.valueAsDate = sevenDaysAgo;
            endDateInput.valueAsDate = today;
            
            // Remove URL parameters
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.delete('start_date');
            currentUrl.searchParams.delete('end_date');
            
            // Set a flag in session storage
            sessionStorage.setItem('just_cleared_filter', 'true');
            
            // Force a full page reload to refresh all data
            window.location.href = currentUrl.toString();
        });
        
        // Set input values from URL parameters if they exist
        const urlParams = new URLSearchParams(window.location.search);
        const startDateParam = urlParams.get('start_date');
        const endDateParam = urlParams.get('end_date');
        
        if (startDateParam) {
            startDateInput.value = startDateParam;
        }
        
        if (endDateParam) {
            endDateInput.value = endDateParam;
        }
        
        // Update filter button text if filter is active
        if (startDateParam && endDateParam) {
            const formattedStartDate = new Date(startDateParam).toLocaleDateString('pt-BR');
            const formattedEndDate = new Date(endDateParam).toLocaleDateString('pt-BR');
            dateFilterBtn.innerHTML = `
                <i data-lucide="calendar" class="h-4 w-4"></i>
                ${formattedStartDate} - ${formattedEndDate}
            `;
            
            // Add active class to button
            dateFilterBtn.classList.add('bg-gray-100');
            dateFilterBtn.classList.add('text-primary');
        }
        
        // Check if page was just reloaded after clearing filter
        const justCleared = sessionStorage.getItem('just_cleared_filter');
        if (justCleared) {
            // Remove the flag
            sessionStorage.removeItem('just_cleared_filter');
            
            // Force charts to redraw
            setTimeout(() => {
                if (classesChart) classesChart.destroy();
                if (distributionChart) distributionChart.destroy();
                if (timeSeriesChart) timeSeriesChart.destroy();
                
                // Reinitialize charts
                initCharts();
            }, 100);
        }
    });
</script>
{% endblock %}